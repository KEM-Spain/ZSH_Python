#!/usr/bin/zsh
# Inline ansi
BOLD="\033[1m"
ITALIC="\033[3m"
RESET="\033[m"
REVERSE="\033[7m"
STRIKE="\033[9m"
UNDER="\033[4m"
BLACK_BG="\033[40m"
BLUE_FG="\033[34m"
CYAN_FG="\033[36m"
GREEN_FG="\033[32m"
MAGENTA_FG="\033[35m"
RED_FG="\033[31m"
WHITE_FG="\033[37m"
YELLOW_FG="\033[33m"
CSR_OFF="\033[?25l"
CSR_ON="\033[?25h"

typeset -A NON_GENERAL=()
typeset -A GENERAL=()

NON_GENERAL[TITLES]='thumbnail__title attr{title}'
NON_GENERAL[LINKS]='title__link attr{href}'
NON_GENERAL[AGES]='videostream__time text{}'
NON_GENERAL[DURATION]='videostream__badge text{}'

GENERAL[AUTHORS]='ellipsis-1 text{}'
GENERAL[TITLES]='video-item--title text{}'
GENERAL[LINKS]='video-item--a attr{href}'
GENERAL[AGES]='video-item--time text{}'
GENERAL[DURATIONS]='video-item--duration attr{data-value}'

strip_space () {
	local LINE

	while read LINE;do
		tr -d '\011' | tr -s '\012' | sed '/^$/d' <<< ${LINE}
	done
}

[[ -e ./classes ]] && /bin/rm -f classes
[[ -e ./rows.html ]] && /bin/rm -f ./rows.html

(
/bin/rm -f ./ROW*html 
)>/dev/null 2>&1

pup '.video-listing-entry' < Rumble.qry >rows.html
if [[ ! -s ./rows.html ]];then
	echo "No rows were detected"
	/bin/rm -f ./rows.html
	exit 1
fi

ROW=1
typeset -a HTML=()
while read -u3 LINE;do
	HTML+=${LINE}
	if [[ ${LINE} =~ \"video-item--img\" ]];then
		for L in ${HTML};do
			echo ${L} >> ROW${ROW}.html
		done
		HTML=()
		((ROW++))
	fi
done 3< rows.html

for (( R=1; R<=ROW; R++ ));do
	if [[ -e ROW${R}.html ]];then
		while read -u3 LINE;do
			for K in ${(k)GENERAL};do
				CLASS=$(cut -d' ' -f1 <<<${GENERAL[${K}]})
				if [[ ${LINE} =~ ${CLASS} ]];then
					eval "pup --charset utf8 '.${GENERAL[${K}]}' < ROW${R}.html | grep -vi verified | strip_space"
				fi
			done
		done 3<ROW${R}.html
	fi
done

exit 0
